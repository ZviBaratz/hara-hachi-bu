#!/usr/bin/env bash
set -eu

# unified-power-ctl - Helper script for Unified Power Manager extension
# Handles privileged operations: setting battery thresholds, force-discharge

BAT0_END_PATH='/sys/class/power_supply/BAT0/charge_control_end_threshold'
BAT0_START_PATH='/sys/class/power_supply/BAT0/charge_control_start_threshold'
BAT1_END_PATH='/sys/class/power_supply/BAT1/charge_control_end_threshold'
BAT1_START_PATH='/sys/class/power_supply/BAT1/charge_control_start_threshold'
BAT2_END_PATH='/sys/class/power_supply/BAT2/charge_control_end_threshold'
BAT2_START_PATH='/sys/class/power_supply/BAT2/charge_control_start_threshold'
BAT3_END_PATH='/sys/class/power_supply/BAT3/charge_control_end_threshold'
BAT3_START_PATH='/sys/class/power_supply/BAT3/charge_control_start_threshold'
BAT0_FORCE_DISCHARGE_PATH='/sys/class/power_supply/BAT0/charge_behaviour'
BAT1_FORCE_DISCHARGE_PATH='/sys/class/power_supply/BAT1/charge_behaviour'
BAT2_FORCE_DISCHARGE_PATH='/sys/class/power_supply/BAT2/charge_behaviour'
BAT3_FORCE_DISCHARGE_PATH='/sys/class/power_supply/BAT3/charge_behaviour'

EXIT_SUCCESS=0
EXIT_ERROR=1
EXIT_NEEDS_UPDATE=2

# Validate that a sysfs path exists before writing
validate_sysfs_path() {
    [[ -f "$1" ]] || { echo "Error: Path does not exist: $1" >&2; exit "$EXIT_ERROR"; }
}

# Validate number of arguments
check_args() {
    local expected=$1
    local actual=$(( $# - 2 )) # Subtract 2 for 'expected' and 'TOOLCMD'
    if [ "$actual" -lt "$expected" ]; then
        echo "Error: Command '$TOOLCMD' requires $expected arguments, but $actual were provided." >&2
        exit "$EXIT_ERROR"
    fi
}

TOOLCMD=${1:-}
ARG1=${2:-}
ARG2=${3:-}

# Helper validation function
is_int() {
    [[ "$1" =~ ^[0-9]+$ ]]
}

validate_threshold() {
    if [ -z "${1:-}" ]; then
        echo "Error: Missing threshold value."
        exit "$EXIT_ERROR"
    fi
    if ! is_int "$1"; then
        echo "Error: Threshold must be an integer."
        exit "$EXIT_ERROR"
    fi
    if [ "$1" -lt 0 ] || [ "$1" -gt 100 ]; then
        echo "Error: Threshold must be between 0 and 100."
        exit "$EXIT_ERROR"
    fi
}

case "$TOOLCMD" in
    BAT0_END)
        check_args 1 "$@"
        validate_threshold "$ARG1"
        validate_sysfs_path "$BAT0_END_PATH"
        echo "$ARG1" >"$BAT0_END_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    BAT0_START)
        check_args 1 "$@"
        validate_threshold "$ARG1"
        validate_sysfs_path "$BAT0_START_PATH"
        echo "$ARG1" >"$BAT0_START_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    BAT0_END_START)
        check_args 2 "$@"
        validate_threshold "$ARG1"
        validate_threshold "$ARG2"
        validate_sysfs_path "$BAT0_END_PATH"
        validate_sysfs_path "$BAT0_START_PATH"
        # Write END first, then START (for increasing thresholds)
        echo "$ARG1" >"$BAT0_END_PATH" &&
            echo "$ARG2" >"$BAT0_START_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    BAT0_START_END)
        check_args 2 "$@"
        validate_threshold "$ARG1"
        validate_threshold "$ARG2"
        validate_sysfs_path "$BAT0_START_PATH"
        validate_sysfs_path "$BAT0_END_PATH"
        # Write START first, then END (for decreasing thresholds)
        echo "$ARG2" >"$BAT0_START_PATH" &&
            echo "$ARG1" >"$BAT0_END_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    BAT1_END_START)
        check_args 2 "$@"
        validate_threshold "$ARG1"
        validate_threshold "$ARG2"
        validate_sysfs_path "$BAT1_END_PATH"
        validate_sysfs_path "$BAT1_START_PATH"
        echo "$ARG1" >"$BAT1_END_PATH" &&
            echo "$ARG2" >"$BAT1_START_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    BAT1_START_END)
        check_args 2 "$@"
        validate_threshold "$ARG1"
        validate_threshold "$ARG2"
        validate_sysfs_path "$BAT1_START_PATH"
        validate_sysfs_path "$BAT1_END_PATH"
        echo "$ARG2" >"$BAT1_START_PATH" &&
            echo "$ARG1" >"$BAT1_END_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    BAT1_END)
        check_args 1 "$@"
        validate_threshold "$ARG1"
        validate_sysfs_path "$BAT1_END_PATH"
        echo "$ARG1" >"$BAT1_END_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    BAT1_START)
        check_args 1 "$@"
        validate_threshold "$ARG1"
        validate_sysfs_path "$BAT1_START_PATH"
        echo "$ARG1" >"$BAT1_START_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    FORCE_DISCHARGE_BAT0)
        check_args 1 "$@"
        if [[ "$ARG1" != "force-discharge" && "$ARG1" != "auto" ]]; then
            echo "Error: Invalid force discharge mode."
            exit "$EXIT_ERROR"
        fi
        validate_sysfs_path "$BAT0_FORCE_DISCHARGE_PATH"
        echo "$ARG1" >"$BAT0_FORCE_DISCHARGE_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    FORCE_DISCHARGE_BAT1)
        check_args 1 "$@"
        if [[ "$ARG1" != "force-discharge" && "$ARG1" != "auto" ]]; then
            echo "Error: Invalid force discharge mode."
            exit "$EXIT_ERROR"
        fi
        validate_sysfs_path "$BAT1_FORCE_DISCHARGE_PATH"
        echo "$ARG1" >"$BAT1_FORCE_DISCHARGE_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    BAT2_END)
        check_args 1 "$@"
        validate_threshold "$ARG1"
        validate_sysfs_path "$BAT2_END_PATH"
        echo "$ARG1" >"$BAT2_END_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    BAT2_START)
        check_args 1 "$@"
        validate_threshold "$ARG1"
        validate_sysfs_path "$BAT2_START_PATH"
        echo "$ARG1" >"$BAT2_START_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    BAT2_END_START)
        check_args 2 "$@"
        validate_threshold "$ARG1"
        validate_threshold "$ARG2"
        validate_sysfs_path "$BAT2_END_PATH"
        validate_sysfs_path "$BAT2_START_PATH"
        echo "$ARG1" >"$BAT2_END_PATH" &&
            echo "$ARG2" >"$BAT2_START_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    BAT2_START_END)
        check_args 2 "$@"
        validate_threshold "$ARG1"
        validate_threshold "$ARG2"
        validate_sysfs_path "$BAT2_START_PATH"
        validate_sysfs_path "$BAT2_END_PATH"
        echo "$ARG2" >"$BAT2_START_PATH" &&
            echo "$ARG1" >"$BAT2_END_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    FORCE_DISCHARGE_BAT2)
        check_args 1 "$@"
        if [[ "$ARG1" != "force-discharge" && "$ARG1" != "auto" ]]; then
            echo "Error: Invalid force discharge mode."
            exit "$EXIT_ERROR"
        fi
        validate_sysfs_path "$BAT2_FORCE_DISCHARGE_PATH"
        echo "$ARG1" >"$BAT2_FORCE_DISCHARGE_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    BAT3_END)
        check_args 1 "$@"
        validate_threshold "$ARG1"
        validate_sysfs_path "$BAT3_END_PATH"
        echo "$ARG1" >"$BAT3_END_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    BAT3_START)
        check_args 1 "$@"
        validate_threshold "$ARG1"
        validate_sysfs_path "$BAT3_START_PATH"
        echo "$ARG1" >"$BAT3_START_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    BAT3_END_START)
        check_args 2 "$@"
        validate_threshold "$ARG1"
        validate_threshold "$ARG2"
        validate_sysfs_path "$BAT3_END_PATH"
        validate_sysfs_path "$BAT3_START_PATH"
        echo "$ARG1" >"$BAT3_END_PATH" &&
            echo "$ARG2" >"$BAT3_START_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    BAT3_START_END)
        check_args 2 "$@"
        validate_threshold "$ARG1"
        validate_threshold "$ARG2"
        validate_sysfs_path "$BAT3_START_PATH"
        validate_sysfs_path "$BAT3_END_PATH"
        echo "$ARG2" >"$BAT3_START_PATH" &&
            echo "$ARG1" >"$BAT3_END_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    FORCE_DISCHARGE_BAT3)
        check_args 1 "$@"
        if [[ "$ARG1" != "force-discharge" && "$ARG1" != "auto" ]]; then
            echo "Error: Invalid force discharge mode."
            exit "$EXIT_ERROR"
        fi
        validate_sysfs_path "$BAT3_FORCE_DISCHARGE_PATH"
        echo "$ARG1" >"$BAT3_FORCE_DISCHARGE_PATH" &&
            exit "$EXIT_SUCCESS" || exit "$EXIT_ERROR"
        ;;
    *)
        echo "Unknown Command: '$TOOLCMD'"
        exit "$EXIT_ERROR"
        ;;
esac
