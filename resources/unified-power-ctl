#!/usr/bin/env bash
set -eu

# unified-power-ctl - Helper script for Unified Power Manager extension
# Handles privileged operations: setting battery thresholds, force-discharge

EXIT_SUCCESS=0
EXIT_ERROR=1

# --- Validation Functions ---

# Validate that a sysfs path exists before writing
validate_sysfs_path() {
    [[ -f "$1" ]] || { echo "Error: Path does not exist: $1" >&2; exit "$EXIT_ERROR"; }
}

# Validate number of arguments
check_args() {
    local expected=$1
    local actual=$(( $# - 2 )) # Subtract 2 for 'expected' and 'TOOLCMD'
    if [ "$actual" -lt "$expected" ]; then
        echo "Error: Command '$TOOLCMD' requires $expected arguments, but $actual were provided." >&2
        exit "$EXIT_ERROR"
    fi
}

# Helper validation function
is_int() {
    [[ "$1" =~ ^[0-9]+$ ]]
}

validate_threshold() {
    if [ -z "${1:-}" ]; then
        echo "Error: Missing threshold value."
        exit "$EXIT_ERROR"
    fi
    if ! is_int "$1"; then
        echo "Error: Threshold must be an integer."
        exit "$EXIT_ERROR"
    fi
    if [ "$1" -lt 0 ] || [ "$1" -gt 100 ]; then
        echo "Error: Threshold must be between 0 and 100."
        exit "$EXIT_ERROR"
    fi
}

# --- Command Parsing ---

TOOLCMD=${1:-}
ARG1=${2:-}
ARG2=${3:-}

# Parse command format: BAT<N>_<ACTION> or FORCE_DISCHARGE_BAT<N>
if [[ "$TOOLCMD" =~ ^BAT([0-9])_(.*)$ ]]; then
    BAT_IDX="${BASH_REMATCH[1]}"
    ACTION="${BASH_REMATCH[2]}"
elif [[ "$TOOLCMD" =~ ^FORCE_DISCHARGE_BAT([0-9])$ ]]; then
    BAT_IDX="${BASH_REMATCH[1]}"
    ACTION="FORCE_DISCHARGE"
else
    echo "Error: Unknown Command: '$TOOLCMD'"
    exit "$EXIT_ERROR"
fi

# Define paths dynamically based on battery index
BAT_PATH="/sys/class/power_supply/BAT${BAT_IDX}"
END_PATH="${BAT_PATH}/charge_control_end_threshold"
START_PATH="${BAT_PATH}/charge_control_start_threshold"
FORCE_DISCHARGE_PATH="${BAT_PATH}/charge_behaviour"

case "$ACTION" in
    END)
        check_args 1 "$@"
        validate_threshold "$ARG1"
        validate_sysfs_path "$END_PATH"
        echo "$ARG1" >"$END_PATH"
        ;;
    START)
        check_args 1 "$@"
        validate_threshold "$ARG1"
        validate_sysfs_path "$START_PATH"
        echo "$ARG1" >"$START_PATH"
        ;;
    END_START)
        check_args 2 "$@"
        validate_threshold "$ARG1"
        validate_threshold "$ARG2"
        validate_sysfs_path "$END_PATH"
        validate_sysfs_path "$START_PATH"
        # Write END first, then START (safe order for increasing range)
        echo "$ARG1" >"$END_PATH" && echo "$ARG2" >"$START_PATH"
        ;;
    START_END)
        check_args 2 "$@"
        validate_threshold "$ARG1"
        validate_threshold "$ARG2"
        validate_sysfs_path "$START_PATH"
        validate_sysfs_path "$END_PATH"
        # Write START first, then END (safe order for decreasing range)
        echo "$ARG2" >"$START_PATH" && echo "$ARG1" >"$END_PATH"
        ;;
    FORCE_DISCHARGE)
        check_args 1 "$@"
        if [[ "$ARG1" != "force-discharge" && "$ARG1" != "auto" ]]; then
            echo "Error: Invalid force discharge mode. Allowed: 'force-discharge', 'auto'."
            exit "$EXIT_ERROR"
        fi
        validate_sysfs_path "$FORCE_DISCHARGE_PATH"
        echo "$ARG1" >"$FORCE_DISCHARGE_PATH"
        ;;
    *)
        echo "Error: Unknown Action: '$ACTION' for BAT$BAT_IDX"
        exit "$EXIT_ERROR"
        ;;
esac

exit "$EXIT_SUCCESS"